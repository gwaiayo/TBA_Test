<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trial Balance Checker — Single‑File Prototype</title>
  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 + ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for in‑browser JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- PapaParse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* Just to ensure the modal overlay sits above everything */
    .modal-open { overflow: hidden; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    function classNames(...xs){
      return xs.filter(Boolean).join(' ');
    }

    function parseAmount(val){
      if (val === null || val === undefined) return 0;
      let s = String(val).trim();
      if (s === '') return 0;
      // Remove currency symbols and spaces
      s = s.replace(/[\s$]/g, '');
      // Handle parentheses for negatives
      let negative = false;
      if (/^\(.*\)$/.test(s)) { negative = true; s = s.slice(1, -1); }
      // Remove thousands separators (commas) — keep decimal point
      s = s.replace(/,/g, '');
      // Replace European decimal comma if present and no period
      if (!s.includes('.') && (s.match(/,/g) || []).length === 0) {
        s = s.replace(',', '.');
      }
      const num = parseFloat(s);
      if (Number.isNaN(num)) return 0;
      return negative ? -num : num;
    }

    function round2(n){
      return Math.round((n + Number.EPSILON) * 100) / 100;
    }

    function App(){
      const [fileName, setFileName] = useState('');
      const [modalOpen, setModalOpen] = useState(false);
      const [result, setResult] = useState(null); // { rowCount, sum, equalsZero, message }
      const [error, setError] = useState('');

      const handleFile = (file) => {
        setError('');
        if (!file) return;
        setFileName(file.name);

        const reader = new FileReader();
        reader.onload = (e) => {
          const csvText = e.target.result;
          Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            transformHeader: (h) => h.trim(),
            complete: (res) => {
              const rows = res.data;
              if (!rows || rows.length === 0) {
                setError('No data rows found in the file.');
                setModalOpen(true);
                return;
              }

              // Normalize keys to find the exact two required columns
              const firstRow = rows[0];
              const keys = Object.keys(firstRow);

              // Try exact, then case-insensitive fuzzy match
              const findKey = (wanted) => {
                if (keys.includes(wanted)) return wanted;
                const lowerWanted = wanted.toLowerCase();
                const found = keys.find(k => k.toLowerCase().trim() === lowerWanted);
                return found || null;
              };

              const accountKey = findKey('Trial Balance Account');
              const amountKey = findKey('Amount');

              if (!accountKey || !amountKey) {
                setError('Missing required columns. Expecting headers: "Trial Balance Account" and "Amount".');
                setModalOpen(true);
                return;
              }

              // Count rows where account value is non-empty
              const rowCount = rows.reduce((acc, r) => {
                const v = (r[accountKey] ?? '').toString().trim();
                return v ? acc + 1 : acc;
              }, 0);

              // Sum amounts
              const sum = rows.reduce((acc, r) => acc + parseAmount(r[amountKey]), 0);
              const sumRounded = round2(sum);
              const equalsZero = Math.abs(sumRounded) < 0.005; // tolerance for tiny FP noise

              setResult({
                rowCount,
                sum: sumRounded,
                equalsZero,
                message: equalsZero ? 'Amount equals zero' : 'Amount does not equal zero'
              });
              setModalOpen(true);
            },
            error: (err) => {
              setError('Failed to parse the file: ' + (err?.message || 'Unknown error'));
              setModalOpen(true);
            }
          });
        };
        reader.onerror = () => {
          setError('Could not read the file.');
          setModalOpen(true);
        };
        reader.readAsText(file);
      };

      const onUpload = (e) => {
        const file = e.target.files?.[0];
        handleFile(file);
      };

      return (
        <div className="max-w-3xl mx-auto p-6">
          <header className="mb-8">
            <h1 className="text-3xl font-bold tracking-tight">Trial Balance Checker</h1>
            <p className="text-slate-600 mt-2">Upload a CSV with two columns: <span className="font-medium">Trial Balance Account</span> and <span className="font-medium">Amount</span>. We'll count the rows and check if the total of the Amount column equals zero.</p>
          </header>

          <main>
            <div className="bg-white shadow rounded-2xl p-6 border border-slate-100">
              <label htmlFor="file" className="block text-sm font-medium text-slate-700">Upload data file (.csv)</label>
              <div className="mt-3 flex items-center gap-3">
                <input
                  id="file"
                  type="file"
                  accept=".csv,text/csv"
                  onChange={onUpload}
                  className="block w-full text-sm text-slate-700 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-slate-900 file:text-white hover:file:bg-slate-800 cursor-pointer"
                />
                {fileName && (
                  <span className="text-xs text-slate-500">Selected: {fileName}</span>
                )}
              </div>

              <div className="mt-6">
                <details className="text-sm text-slate-600">
                  <summary className="cursor-pointer select-none font-medium">CSV format tips</summary>
                  <div className="mt-2 space-y-1">
                    <p>First row should be headers: <code>Trial Balance Account,Amount</code></p>
                    <p>Amounts may include commas, parentheses for negatives, or currency symbols (e.g., <code>(1,234.56)</code>, <code>$100.00</code>).</p>
                  </div>
                </details>
              </div>
            </div>
          </main>

          {/* Modal */}
          {modalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center">
              <div className="absolute inset-0 bg-black/40" onClick={() => setModalOpen(false)}></div>
              <div className="relative bg-white w-full max-w-md mx-auto rounded-2xl shadow-2xl p-6">
                <h2 className="text-xl font-semibold">Results</h2>
                <div className="mt-4">
                  {error ? (
                    <div className="rounded-lg border border-red-200 bg-red-50 p-3 text-red-800 text-sm">
                      {error}
                    </div>
                  ) : result ? (
                    <div className="space-y-2 text-sm">
                      <div className="flex items-center justify-between">
                        <span className="text-slate-600">Count of rows (Trial Balance Account):</span>
                        <span className="font-semibold">{result.rowCount}</span>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-slate-600">Sum of Amount:</span>
                        <span className="font-mono">{result.sum.toFixed(2)}</span>
                      </div>
                      <div className={classNames(
                        'mt-3 rounded-lg p-3 text-sm',
                        result.equalsZero ? 'bg-emerald-50 border border-emerald-200 text-emerald-800' : 'bg-amber-50 border border-amber-200 text-amber-800'
                      )}>
                        {result.message}
                      </div>
                    </div>
                  ) : (
                    <p className="text-slate-600">No result yet.</p>
                  )}
                </div>
                <div className="mt-6 flex justify-end gap-3">
                  <button
                    className="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-800"
                    onClick={() => { setError(''); setResult(null); setModalOpen(false); }}
                  >Close</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
